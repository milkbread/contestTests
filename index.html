<!DOCTYPE html>
<html>
<head>
  <title>Testmap</title>
  <meta charset="utf-8" />
  <script src="leaflet.js"></script>
  <script src="d3.v3.min.js"></script>
  <script src="topojson.v1.min.js"></script>
  <style>
  @import url(leaflet.css);
  </style>
</head>
<body>
  <h2>This is a live-demo of the current tests</h2>
  <div id="map" style="width: 700px; height: 500px"></div>
  <script>
  var map = L.map('map').setView([43.55, -71.71], 7);
  var toolserver = L.tileLayer('http://{s}.www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png');
  var stamen = L.tileLayer('http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png', {attribution: 'Add some attributes here!'}).addTo(map);
  var baseLayers = {"stamen": stamen, "toolserver-mapnik":toolserver};

  var overlays = {};

  loadData();

  function loadData() {
    var data = {topology: null, lines: null};
    d3.json("results/all_features_topo.json", function(error, topology) {
        data.topology = topology;
        d3.json("results/lines.json", function(error, lines) {
            data.lines = lines;
            renderFeatures(data);
        })
    })
  }

  function renderFeatures(data) {
    var _lines_ = data.lines;
    var topology = data.topology;
    // add the lines to the map
    var lines = topojson.feature(topology, topology.objects.lines);
    var linesTopoJSON = [_lines_];
    var geojsonLines = L.geoJson(linesTopoJSON, {onEachFeature: onEachFeature}).addTo(map);
    overlays["Lines"] = geojsonLines;

    // add the points to the map
    var points = topojson.feature(topology, topology.objects.points);
    var pointMarkers_ = [];
    points.features.forEach(function(d,i){
      var coords = d.geometry.coordinates;
      var circle = L.circle([coords[1], coords[0]], 500, {
          onEachFeature: onEachFeature,
          color: 'red',
          fillColor: '#f03',
          fillOpacity: 0.5
      });
      pointMarkers_.push(circle)
    })
    var pointMarkers = L.layerGroup(pointMarkers_).addTo(map);
    overlays["Points - Input"] = pointMarkers;

    // add the intersection points to the map
    var iPoints = topojson.feature(topology, topology.objects.intersection_points);
    var iPointMarkers_ = [];
    iPoints.features.forEach(function(d,i){
      var coords = d.geometry.coordinates;
      var circle = L.circle([coords[1], coords[0]], 500, {
          color: 'green',
          fillColor: '#0f0',
          fillOpacity: 0.5
      });
      iPointMarkers_.push(circle)
    })
    var iPointMarkers = L.layerGroup(iPointMarkers_);
    overlays["Points - Intersection"] = iPointMarkers;

    var intersection_r_tree = topojson.feature(topology, topology.objects.intersections_r_tree);
    var intersection_r_tree_ = L.geoJson(intersection_r_tree, {
        onEachFeature: onEachFeature,
        style : {color: 'green'}
    });
    overlays["Intersections by RTree"] = intersection_r_tree_;

    var treeRectangles = topojson.feature(topology, topology.objects.rectangles);
    var rectangles = L.geoJson(treeRectangles, {
        onEachFeature: onEachFeature,
        style : {color: 'red'}
    });
    overlays["Tree rectangles"] = rectangles;

    var bufferedPoints = topojson.feature(topology, topology.objects.buffered_points);
    var buffers = L.geoJson(bufferedPoints, {
        onEachFeature: onEachFeature,
        style : {color: 'yellow'}
    });
    overlays["Buffers"] = buffers;

    L.control.layers(baseLayers, overlays).addTo(map);

  }

  function onEachFeature(feature, layer) {
      // does this feature have a property named popupContent?
      if (feature.id) {
          layer.bindPopup("ID: " + feature.id);
      }
  }
  </script>
 </body>
</html>